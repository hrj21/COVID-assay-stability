---
title: "SARS-Cov2 ELISA stability 2"
author: "Hefin Rhys"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  prettydoc::html_pretty:
    theme: cayman
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, dev = "svg")
```

## Purpose and scope

This is an R Markdown document illustrating my stability analysis of the ELISA data generated by Laura. This data was generated from 62 samples. Each sample was read only once per plate, but two identical plates were run each day, for five days. Absorbance readings at 405nm were taken only once, at 15 minutes.

The purpose of this document is to explore, visualize, and summarize the inter-assay variability of these readings. As each sample was run only once per plate, the intra-assay variability cannot be estimated, but the inter-assay variability can be estimated, both within and between days. We also only have a single timepoint to work from. I'm also not comparing the blank, negative control, and positive control variation, as their well positions are not constant across all days. Unlike the previous analysis, these samples are annotated as to whether they are from:

- patients known to have SARS-Cov2 infection (Cov-pos)
- patients known to have a seasonal coronavirus infection (Seasonal)
- patients known to be SARS-Cov 2 negative (Cov-neg)

```{r read data}
library(vegan)
library(tidyverse)

elisa <- read_csv("../data/5 ELISA data (laura).csv")
```

## Visualizing within-day variation

To get an idea of the inter-assay variation for plates run on the same day, I calculate three metrics from the absorbances (abs) of each unknown, $i$, for plate replicates 1 and 2 from that day:

- the range, which is simply the difference between the largest and smallest value $$\textrm{range}_i = |abs_1 - abs_2|_i$$

- the percentage difference, which is the range expressed as a percentage of the mean $$\textrm{percentage difference}_i = \frac{|abs_1 - abs_2|_i} 
{\bigg(\frac{abs_1 + abs_2}{2}\bigg)_i} \times 100$$

- the percentage coefficient of variation, which is the standard deviation expressed as a percentage of the mean $$\textrm{% CV}_i = \frac{\textrm{standard deviation}_i}{\textrm{mean}_i} \times 100$$


```{r within day}
within_day <- elisa %>%
  mutate(Row = match(str_sub(Well, 1, 1), LETTERS[1:8]), 
         Column = as.integer(str_sub(Well, 2, -1))) %>%
  
  drop_na() %>%
  
  group_by(Read, Sample) %>%
  
  mutate(Range = abs(Abs1 - Abs2),
         Mean = mean(c(Abs1, Abs2)),
         Percent_diff = Range / Mean * 100,
            CV = sd(c(Abs1, Abs2)) / Mean * 100)
```

Next, I plot them as heatmaps where the labels underneath show the date for each pair of replicates. The x and y labels correspond to the plate coordinates. Note that blanks and controls are not shown. These plots just help us spatially refer the values to the position on the plates.

The Cov-neg samples occupy rows A to D, the Cov-pos samples occupy rows E and H, and the Seasonal samples occupy rows F and G.

There don't appear to be sample-specific patterns that propogate between days, except that the Cov-pos samples tend to have larger ranges, and lower percent differences and % CVs than the other samples. This is, of course, because they have higher absolute absorbance values. Note that this is another key difference between this dataset and the previous one: the previous dataset consisted of almost entirely positively samples, whereas this dataset has positive and negative. As such, from here on I will decompose the variability by sample type.

```{r}
plot_heat <- function(data, variable, threshold) {
  data %>% 
    mutate(fill = min(c({{variable}}, {{threshold}}))) %>%
    ggplot(aes(Column, Row, fill = fill)) +
    facet_grid( ~ Read, switch = "x") +
    geom_tile() +
    scale_x_continuous(breaks = 1:12,
                       labels = as.character(1:12),
                       expand = c(0, 0),
                       position = "top") +
    scale_y_reverse(breaks = 1:8, labels = LETTERS[1:8],
                    expand = c(0, 0)) +
    scale_fill_viridis_c() +
    coord_equal() +
    theme_bw() +
    labs(fill = deparse(substitute(variable))) +
    theme(axis.title = element_blank(),
          panel.grid.major = element_blank(),
          panel.ontop = TRUE,
          panel.background = element_rect(fill = "transparent"))
}

```

### Absorbance range
```{r fig.height=8, fig.width=12}
plot_heat(within_day, Range, 0.5) + theme(legend.position = "top")
```

### Percentage difference
```{r fig.height=8, fig.width=12}
plot_heat(within_day, Percent_diff, 50) + theme(legend.position = "top")
```

### %CV
```{r fig.height=8, fig.width=12}
plot_heat(within_day, CV, 25) + theme(legend.position = "top")
```

Next, I plot each well as a point. These plots help us to compare the variation between the sample types and between each plate replicate run on the same day. There are some important observations:

- the Cov-pos samples tend to have larger ranges but smaller percent differences and % CVs
- the variability in the Cov-neg and Seasonal samples is very similar
- there was one sample with an anomalously high discrepancy between the plate replicates read on 2020 06 05

```{r}
plot_point <- function(data, variable) {
  data %>% 
    group_by(Read, Label, Sample) %>%
    summarize(across(Range:CV, mean)) %>%
    ggplot(aes(Label, {{variable}})) +
    facet_grid(~ Read) +
    scale_color_brewer(type = "qual", palette = "Set1") +
    geom_point(position = position_jitter(0.2), size = 2) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.x = element_blank())
}
```

### Absorbance range

```{r}
plot_point(within_day, Range)
```

### Percentage difference
```{r}
plot_point(within_day, Percent_diff)
```

### % CV
```{r}
plot_point(within_day, CV)
```



```{r}
plot_point <- function(data, variable) {
  data %>%
    group_by(Read, Seasonal, Well) %>%
    summarize(across(.cols = c(Range, Percent_diff, CV),
                     .fun = mean)) %>%
    ggplot(aes(Type, {{variable}}, col = Plate_replicate)) +
    facet_grid(Time ~ Plate) +
    scale_color_brewer(type = "qual", palette = "Set1") +
    geom_point(position = position_dodge(0.3), size = 2) +
    theme_bw()
}
```

## Calculating within-day variation for each sample type

To summarize the within-day variation, I calculate the mean of the within-day range, percentage difference, and % CV for each sample type, across the different days. The means ± 1 standard deviation are shown. This table summarizes what was shown in the plots above: that the variability, once normalized by signal intensity, is smaller for the Cov-pos samples than for the Cov-neg and Seasonal samples (which are comparable to each other).

```{r, results = "asis"}
knitr::kable(
  within_day %>%
    group_by(Label) %>%
      #ungroup() %>%
      summarize(across(Range:CV, list("mean" = mean, "sd" = sd))) %>%
      mutate(across(where(is.numeric), round, digits = 2)) %>%
      mutate(Range = paste(Range_mean, "±", Range_sd),
             Percent_diff = paste(Percent_diff_mean, "±", Percent_diff_sd),
             CV = paste(CV_mean, "±", CV_sd)) %>%
      select(Label, Range, Percent_diff, CV)
)
```

To explore the relationship between sample type and variability, I plot the mean of the absorbance values for each sample within each day, and plot that against the % CV (this was Lotte Carr's idea). As the mean absorbance value increases, the % CV decreases. In addition to having a higher % CV on average, samples with low mean absorbances also have a more variable spread of % CV values. This raises the important question of how to appropriately summarise the stability of this assay, if the stability depends on the output value of the assay itself.

```{r}
ggplot(within_day, aes(Mean, CV, col = Label)) +
  #facet_wrap(~ Read) +
  geom_point() +
  geom_smooth(col = "black", group = 1, method = "lm", se = FALSE) +
  theme_bw()
```


## Including between-day variation

To get an idea of the inter-assay variation for plates run on the different days, I used the mean absorbance values for each sample within each day, to calculate three metrics from the absorbances (abs) of each unknown, $i$, in the same well across each distinct day, $j$. Here, $n$ is the number of distinct days.

- the range, which is simply the difference between the largest and smallest value $$\textrm{range}_{i} = max(abs_{i}) - min(abs_{i})$$

- the percentage difference, which is the range expressed as a percentage of the mean $$\textrm{percentage difference}_{i} = \frac{max(abs_{i}) - min(abs_{i})} 
{\bigg(\frac{1}{n} \sum_{j=1}^{n} abs_{j}\bigg)} \times 100$$

- the percentage coefficient of variation across the plates, which is the standard deviation expressed as a percentage of the mean $$\textrm{% CV}_{i} = \frac{\textrm{standard deviation}_{i}}{\textrm{mean}_{i}} \times 100$$

```{r between day}
between_day <- within_day %>%
  group_by(Sample, Label, Column, Row) %>%
  
  summarize(Range = range(Mean),
            Percent_diff = Range / mean(Mean) * 100,
            CV = sd(Mean) / mean(Mean) * 100)
```

Next, I plot them as heatmaps summarizing the between-day variation for each well. The x and y labels correspond to the plate coordinates. Note that blanks and controls are not shown. These plots just help us spatially refer the values to the position on the plates.

The Cov-neg samples occupy rows A to D, the Cov-pos samples occupy rows E and H, and the Seasonal samples occupy rows F and G.

The Cov-pos samples tend to have larger ranges and percent differences, and lower % CVs than the other samples. Note that the sample in F2 corresponds to the anomalously high % CV sample seen in the within-day heatmaps for 2020 06 05. Because this sample drives the scale higher and makes it difficult to compare differences between the other samples, I redraw this heatmap, setting each sample ($i$)'s % CV value to:
$$\textrm{rescaled % CV}_i = \min(\textrm{%CV}_i, 25)$$
This effectively sets each tile to saturate for any value >= 25%. This makes it easier to see that the % CV values for the Cov-pos samples tend to be lower than the Cov-neg samples and Seasonal samples. Also, except for wells F2 and F9, the % CV of the Seasonal samples is slightly lower than the Cov-neg samples, suggesting they are more reproducible between days (though this was not true within each day).

```{r}
plot_heat_inter <- function(data, variable, threshold) {
  data %>% 
    mutate(fill = min(c({{variable}}, {{threshold}}))) %>%
    ggplot(aes(Column, Row, fill = fill)) +
    # facet_grid(Time ~ Plate, switch = "x") +
    geom_tile() +
    scale_x_continuous(breaks = 1:12,
                       labels = as.character(1:12),
                       expand = c(0, 0),
                       position = "top") +
    scale_y_reverse(breaks = 1:8, labels = LETTERS[1:8],
                    expand = c(0, 0)) +
    scale_fill_viridis_c() +
    coord_equal() +
    labs(fill = deparse(substitute(variable))) +
    theme_bw() +
    theme(panel.spacing.x = unit(0.5, "lines"),
          axis.title = element_blank(),
          panel.grid.major = element_blank(),
          panel.ontop = TRUE,
          panel.background = element_rect(fill = "transparent"))
}
```


### Absorbance range
```{r}
plot_heat_inter(between_day, Range, 50)
```

### Percentage difference
```{r}
plot_heat_inter(between_day, Percent_diff, 500)
```

### % CV
```{r}
plot_heat_inter(between_day, CV, 90)
```

### Rescaled % CV
```{r}
plot_heat_inter(between_day, CV, 25)
```

Next, I plot each well as a point. These plots help us to compare the variation between the sample types, between days. The same patterns of within-day variation are present in the between-day variation.

```{r}
plot_point_inter <- function(data, variable) {
  data %>%
    group_by(Sample, Label) %>%
    summarize(across(.cols = c(Range, Percent_diff, CV),
                     .fun = mean)) %>%
    ggplot(aes(Label, {{variable}})) +
    #facet_grid(Time ~ Plate) +
    scale_color_brewer(type = "qual", palette = "Set1") +
    geom_point(position = position_jitter(0.1), size = 2) +
    theme_bw()
}
```


### Absorbance range

```{r}
plot_point_inter(between_day, Range)
```

### Percentage difference
```{r}
plot_point_inter(between_day, Percent_diff)
```

### % CV
```{r}
plot_point_inter(between_day, CV)
```

## Calculating between-day variation for each sample type

To summarize the between-day variation, I calculate the mean of the between-day range, percentage difference, and % CV for each sample type. The means ± 1 standard deviation are shown. The summary here is similar to the within-day variation with one important difference: the within-day % CVs are considerably smaller then the between day % CVs, which is to be expected. As a reminder, the within-day % CVs were:

- Cov-neg: 14.06 ± 10.22
- Cov-pos: 3.96 ± 4.14
- Seasonal: 13.99 ± 14.53

In addition to the mean % CVs being larger, the spread is also more variable.

```{r, results = "asis"}
knitr::kable(
  between_day %>%
    group_by(Label) %>%
      #ungroup() %>%
      summarize(across(Range:CV, list("mean" = mean, "sd" = sd))) %>%
      mutate(across(where(is.numeric), round, digits = 2)) %>%
      mutate(Range = paste(Range_mean, "±", Range_sd),
             Percent_diff = paste(Percent_diff_mean, "±", Percent_diff_sd),
             CV = paste(CV_mean, "±", CV_sd)) %>%
      select(Label, Range, Percent_diff, CV)
)
```

## Calculating Jaccard's distance

As the variability depends so strongly on signal strength, the intra and inter-assay variability cannot be summarized by a single statistic. One option would be to describe the variability as a function of signal strength, but this isn't so easy for people to interpret.

Instead, arguably the most important measure of stability is whether, using the heuristic rules for classification defined by George, the assay assigns the same label for each sample within and between assays. The natural statistic to summarize the stability of a categorical label is the Jaccard distance.

The three possible outputs for each well (assuming the plate doesn't fail) are:

- Detected
- Not detected
- Indeterminate

The Jaccard distance for a partcular outcome between two plates from the same day is defined as: $$J_{A,B} = 1 - \frac{|A \cap B|}{|A \cup B|}$$

where A and B are the set of outcomes for the wells in plate A and B, respectively (e.g. A = {D, ND, ND, I}, B = {D, ND, D, I}), $|A \cap B|$ is the number of elements common to both sets, and $|A \cup B|$ is the number of elements in one set but not the other.

Calculating the Jaccard distance like this for each day, per possible outcome gives us 0 values for all three outcomes, for each plate replicate. This shows that on each day, every single well outcome (detected, not detected, indeterminate) was the same between the two plates. Note that no wells came up as indeterminate in this round of ELISAs.

```{r}
elisa_long <- elisa %>%
  pivot_longer(cols = c(Abs1, Abs2), 
               names_to = "Plate_replicate",
               values_to = "Abs") %>%
  group_by(Read, Plate_replicate) 

elisa_b <- elisa_long %>%
  filter(Label == "Negative" | Label == "Blank") %>%
  summarize(b = mean(Abs))

elisa_c <- elisa_long %>%
  filter(Label == "Positive") %>%
  summarize(c = mean(Abs))

elisa_result <- left_join(elisa_long, elisa_b) %>% 
  left_join(elisa_c) %>%
  mutate(t1 = (0.25 * c) + b,
         t2 = (0.35 * c) + b,
         Result = case_when(Abs <= t1 ~ "Not detected",
                            Abs > t1 & Abs <= t2 ~ "Indeterminate",
                            Abs > t2 ~ "Detected"))
         
```

```{r}
knitr::kable(
  elisa_result %>%
  select(Read, Label, Sample, Plate_replicate, Result) %>%
  ungroup() %>%
  pivot_wider(id_cols = c(Read, Sample, Label), 
              names_from = Plate_replicate,
              values_from = Result,
              values_fn = unique) %>%
  filter(Label != "Positive" & Label != "Negative" & Label != "Blank") %>%
  group_by(Read) %>%
  mutate(Not_det_int = case_when(
    Abs1 == "Not detected" & Abs2 == "Not detected" ~ 1,
    TRUE ~ 0
  ), Not_det_union = case_when(
    Abs1 == "Not detected" | Abs2 == "Not detected" ~ 1,
    TRUE ~ 0
  ), Det_int = case_when(
    Abs1 == "Detected" & Abs2 == "Detected" ~ 1,
    TRUE ~ 0
  ), Det_union = case_when(
    Abs1 == "Detected" | Abs2 == "Detected" ~ 1,
    TRUE ~ 0
  ), Ind_int = case_when(
    Abs1 == "Indeterminate" & Abs2 == "Indeterminate" ~ 1,
    TRUE ~ 0
  ), Ind_union = case_when(
    Abs1 == "Indeterminate" | Abs2 == "Indeterminate" ~ 1,
    TRUE ~ 0)) %>%
  summarize(Not_det_int = sum(Not_det_int), 
            Not_det_union = sum(Not_det_union),
            Det_int = sum(Det_int),
            Det_union = sum(Det_union),
            Ind_int = sum(Ind_int),
            Ind_union = sum(Ind_union)) %>%
  mutate(Not_detected = 1 - (Not_det_int / Not_det_union),
         Detected = 1 - (Det_int / Det_union),
         Indeterminate = min(c(1 - (Ind_int / Ind_union)), 0, na.rm = TRUE)) %>%
  select(Read, Not_detected, Detected, Indeterminate)
)
```

Next, I calculate the Jaccard distances for the outcome values between all the plates. This is shown in matrix form where the value in row 1 column 1 represents the Jaccard distance between plate 1 and 2 etc. All elements of this matrix are zero, indicating that despite the variations in absorbance values, the assay outputs the same classification for all wells between plates.

```{r}
elisa_result %>%
  select(Read, Label, Sample, Plate_replicate, Result) %>%
  ungroup() %>%
  filter(Label != "Positive" & Label != "Negative" & Label != "Blank") %>%
  count(Read, Result) %>%
  pivot_wider(names_from = Result, values_from = n) %>%
  select(-Read) %>%
  vegdist(method = "jaccard")
```


## Conclusions

Here are a summary of my thoughts based on this analysis:

- the variability of the assay depends strongly on the absorbance value of the sample under consideration, and it is therefore impossible to summarize the intra and inter-assay variation with a single statistic
- instead, the assay variation should be summarized either:
    + relative to standards of known concentration (e.g. "for samples with known concentration, x,  of IgG, the intra and inter-assay CVs are y")
    + by a function that relates intra and inter-assay CVs to concentration. This is easy to do, but we need intra and inter-assay repeats of a standard curve, or a series of serum samples with absorbances that cover the typical assay range
    + using the Jaccard distance for samples classified as detected, not detected and indeterminate by the classification heuristic
- Laura's within day % CVs are comparable to the intra-assay % CVs observed in our hands (the between day/inter-assay % CVs cannot be directly compared as they were calculated differently)
